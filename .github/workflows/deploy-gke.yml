name: Deploy K8S

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: google-github-actions/setup-gcloud@1bee7de035d65ec5da40a31f8589e240eba8fde5
        with:
          workload_identity_provider: projects/1055208873800/locations/global/workloadIdentityPools/github/providers/veterinaria
          project-id: ${{ secrets.GKE_PROJECT }}

      # Get the GKE credentials so we can deploy to the cluster
      - uses: google-github-actions/get-gke-credentials@db150f2cc60d1716e61922b832eae71d2a45938f
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_ZONE }}
          project-id: ${{ secrets.GKE_PROJECT }}

      - name: List files in kube directory
        run: |
          ls kube/

      - name: Deploy to GKE
        working-directory: ./kube
        run: |
          kubectl apply -f auth-gateway/
          kubectl apply -f backend/
          kubectl apply -f frontend/
          kubectl apply -f auth-microservice/
          kubectl apply -f mongo/
          kubectl apply -f postgresql/
          kubectl apply -f socket/
          kubectl apply -f graphql/

      - name: Get pods status
        run: kubectl get pods
